<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resource Tracker</title>
    <link rel="stylesheet" href="/static/css/base.css">
    <link rel="stylesheet" href="/static/css/resources.css">
    <link rel="stylesheet" href="/static/css/schematics.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="app-container">
        <header class="main-header">
            <div class="logo">SWG TRACKER</div>
            <nav class="top-nav">
                <button class="nav-btn active" data-target="resources-container">RESOURCES</button>
                <button class="nav-btn" data-target="schematics-container">SCHEMATICS</button>
            </nav>
            <div class="header-controls">
                </div>
        </header>

        <main id="main-content">
            <section id="resources-container" class="page-container active">
                <table class="resource-table">
                    </table>
            </section>

            <section id="schematics-container" class="page-container">
                <div class="placeholder-msg">Schematics functionality coming soon...</div>
            </section>
        </main>

        <div class="workspace">
            <aside class="site-nav">
                <h3>Nav</h3>
                <ul class="tree-list">
                    <li class="tree-node">Resources</li>
                    <li class="tree-node">Schematics</li>
                </ul>
            </aside>

            <main class="log-container">
                <table class="resource-table">
                    <thead>
						<tr>
							<th class="col-name"><div class="sort-header" onclick="toggleSort('name')">NAME...</div></th>
							<th class="col-type"><div class="sort-header" onclick="toggleSort('type')">TYPE...</div></th>
							<th class="col-stat"><div class="sort-header" onclick="toggleSort('res_oq')">OQ...</div></th>
							<th class="col-stat"><div class="sort-header" onclick="toggleSort('res_cd')">CD...</div></th>
						</tr>
					</thead>
                    <tbody id="resource-log-body"></tbody>
                </table>
            </main>
        </div>
    </div>
<script>
    async function toggleStatus(button, resourceName) {
        const statusSpan = button.previousElementSibling;
        const currentlyActive = statusSpan.textContent === "Active";
        const newState = !currentlyActive;

        // Optimistic UI update
        statusSpan.textContent = newState ? "Active" : "Inactive";
        statusSpan.className = `status-text ${newState ? 'active' : 'inactive'}`;

        try {
            const response = await fetch('http://127.0.0.1:5000/api/update-status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: resourceName, is_active: newState })
            });

            if (response.ok) {
                refreshSingleRow(resourceName);
            }
        } catch (error) {
            console.error("Failed to save status:", error);
        }
    }

    function updateDropdownVisibility(selectElement) {
        // Count how many options are currently visible (not display: none)
        // We ignore the first option because it's the "+" placeholder
        const options = Array.from(selectElement.options).slice(1);
        const visibleOptions = options.filter(opt => opt.style.display !== "none");

        // Hide the select if no planets are left to choose
        if (visibleOptions.length === 0) {
            selectElement.style.visibility = "hidden";
        } else {
            selectElement.style.visibility = "visible";
        }
    }

    async function togglePlanet(selectElement, resourceName) {
        const planetValue = selectElement.value;
        if (!planetValue) return;

        const container = selectElement.closest('.location-cell').querySelector('.planets-container');
        
        let currentPlanets = Array.from(container.querySelectorAll('.planet'))
                                  .map(p => p.getAttribute('data-tooltip').toLowerCase());
        
        // Add if not present, remove if it is (Toggle)
        const index = currentPlanets.indexOf(planetValue);
        if (index > -1) {
            currentPlanets.splice(index, 1);
        } else {
            currentPlanets.push(planetValue);
        }

        currentPlanets.sort();

        try {
            const response = await fetch('http://127.0.0.1:5000/api/update-planets', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: resourceName, planets: currentPlanets })
            });
            if (response.ok) {
                refreshSingleRow(resourceName);    
            }
        } catch (error) {
            console.error("Failed to toggle planet:", error);
        }

        selectElement.value = ""; 
    }

    function renderPlanetBadges(container, planetList, selectElement, resourceName) {
        const rowId = `row-${resourceName.replace(/\s+/g, '-')}`;
        const row = document.getElementById(rowId);
        container.innerHTML = '';
        planetList.forEach(p => {
            const span = document.createElement('span');
            span.className = `planet ${p}`;
            span.setAttribute('data-tooltip', p.charAt(0).toUpperCase() + p.slice(1));
            span.textContent = p.charAt(0).toUpperCase();
            
            // Removal logic
            span.onclick = async () => {
                const newList = planetList.filter(item => item !== p);
                // Re-run the update-planets fetch here for removal...
                container.remove(); // Simplify for now: full refresh is safer
                // refreshSingleRow(); 
            };
            container.appendChild(span);
        });
    }

    async function handleBadgeClick(event, resourceName, planetValue) {
        // 1. Get the actual element from the event
        const badgeElement = event.currentTarget;
        
        // 2. Find the container relative to the clicked badge
        const container = badgeElement.closest('.planets-container');
        
        if (!container) {
            console.error("Could not find .planets-container for", resourceName);
            return;
        }

        // 3. Get current list from badges in this specific container
        let currentPlanets = Array.from(container.querySelectorAll('.planet'))
                                  .map(p => p.getAttribute('data-tooltip').toLowerCase());
        
        // 4. Filter out the clicked planet
        const newList = currentPlanets.filter(p => p !== planetValue);
        
        // 5. Save to DB
        try {
            const response = await fetch('http://127.0.0.1:5000/api/update-planets', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: resourceName, planets: newList })
            });
            
            if (response.ok) {
                refreshSingleRow(resourceName); // Refresh table data
            }
        } catch (e) {
            console.error("Error removing planet:", e);
        }
    }

    async function refreshSingleRow(resourceName) {
        try {
            const response = await fetch(`http://127.0.0.1:5000/api/resource/${resourceName}`)
            const res = await response.json();

            const rowId = `row-${resourceName.replace(/\s+/g, '-')}`;
            const row = document.getElementById(rowId);

            const rawDate = new Date(res.date_reported);
            const day = String(rawDate.getUTCDate()).padStart(2, '0')
            const month = String(rawDate.getUTCMonth() + 1).padStart(2, '0')
            const year = rawDate.getUTCFullYear();
            const formattedDate = `${day}/${month}/${year}`;

            const statusText = res.is_active ? "Active" : "Inactive";
            const statusClass = res.is_active ? "active" : "inactive";

            if (!row) return;

            const ALL_PLANETS = [
                    "Corellia", "Dantooine", "Dathomir", "Endor", "Kashyyyk", 
                    "Lok", "Mustafar", "Naboo", "Rori", "Talus", "Tatooine", "Yavin"
            ];

            const assignedPlanets = (res.planets || []).map(p => p.toLowerCase());
            const availableOptions = ALL_PLANETS
                .filter(p => !assignedPlanets.includes(p.toLowerCase()))
                .map(p => `<option value="${p.toLowerCase()}">${p}</option>`)
                .join('');

            const planetBadges = (res.planets || []).map(p => {
                const planetLower = p.toLowerCase();
                return `<span class="planet ${planetLower}" 
                              data-tooltip="${p}" 
                              onclick="handleBadgeClick(event, '${res.name}', '${planetLower}')">
                              ${p.charAt(0).toUpperCase()}
                        </span>`;
            }).join(' ');

            row.innerHTML = `
                    <td class="res-name">${res.name}</td>
                    <td class="res-type">${res.type}</td>
                    <td class="stat-cell ${res.res_oq > 900 ? 'high-quality' : ''}">${res.res_oq || '--'}</td>
                    <td class="stat-cell">${res.res_cd || '--'}</td>
                    <td class="stat-cell">${res.res_dr || '--'}</td>
                    <td class="stat-cell">${res.res_fl || '--'}</td>
                    <td class="stat-cell">${res.res_hr || '--'}</td>
                    <td class="stat-cell">${res.res_ma || '--'}</td>
                    <td class="stat-cell">${res.res_pe || '--'}</td>
                    <td class="stat-cell">${res.res_ut || '--'}</td>
                    <td class="location-cell">
                        <div class="planets-container">${planetBadges}</div>
                        <div class="planet-controls">
                            <select class="planet-select" onchange="togglePlanet(this, '${res.name}')">
                                <option value="" disabled selected>+</option>
                                ${availableOptions}
                            </select>
                        </div>
                    </td>
                    <td class="date-cell">${formattedDate}</td>
                    <td class="status-cell">
                        <div class="status-container">
                            <span class="status-text ${statusClass}">${statusText}</span>
                            <button class="toggle-status-btn" onclick="toggleStatus(this, '${res.name}')" data-tooltip="Toggle Status"></button>
                        </div>
                    </td>
                    <td class="stat-cell"></td>
                `;
        } catch (e) {
            console.error("Error refreshing row:", e);
        }
    }

    function updateSortVisuals() {
        document.querySelectorAll('.sort-btns span').forEach(el => {
            el.classList.remove('active-up', 'active-down');
        });

        sortStack.forEach(sort => {
            const headerDiv = document.querySelector(`.sort-header[onclick*="'${sort.key}'"]`);
            if (headerDiv) {
                const btn = sort.direction === 'asc' ? headerDiv.querySelector('.up') : headerDiv.querySelector('.down');
                btn.classList.add(sort.direction === 'asc' ? 'active-up' : 'active-down');
            }
        });
    }

    function applyAllTableTransforms() {
        let data = [...rawResourceData];

        // 1. Apply Multi-Column Sort
        if (sortStack.length > 0) {
            data.sort((a, b) => {
                for (let sort of sortStack) {
                    let valA = a[sort.key];
                    let valB = b[sort.key];

                    // Handle nulls
                    if (valA === null) valA = -1;
                    if (valB === null) valB = -1;

                    if (valA !== valB) {
                        const modifier = sort.direction === 'asc' ? 1 : -1;
                        return valA > valB ? modifier : -modifier;
                    }
                }
                return 0;
            });
        }

        renderTable(data);
        applyFilters(); // Re-apply search and taxonomy filters on the sorted list
    }

    function toggleSort(key) {
        const existingIdx = sortStack.findIndex(s => s.key === key);
        
        if (existingIdx === -1) {
            sortStack.push({ key, direction: 'asc' });
        } else if (sortStack[existingIdx].direction === 'asc') {
            sortStack[existingIdx].direction = 'desc';
        } else {
            sortStack.splice(existingIdx, 1); // Remove from sort if clicked while descending
        }
        
        updateSortVisuals();
        applyAllTableTransforms();
    }

    let sortStack = []; // Stores objects like { key: 'res_oq', direction: 'asc' }
    let rawResourceData = []; // Store the original data from loadResources
    async function loadResources() {
        try {
            const response = await fetch('http://localhost:5000/api/resource_log');
            rawResourceData = await response.json();
            // renderTable(rawResourceData);
            if (!Array.isArray(rawResourceData)) {
                console.error("rawResourceData received from backend:", rawResourceData)
                return
            }
            const tableBody = document.getElementById('resource-log-body');

            tableBody.innerHTML = '';

            rawResourceData.forEach(res => {

                const row = document.createElement('tr');
                row.id = `row-${res.name.replace(/\s+/g, '-')}`;

                const rawDate = new Date(res.date_reported);
                const day = String(rawDate.getUTCDate()).padStart(2, '0')
                const month = String(rawDate.getUTCMonth() + 1).padStart(2, '0')
                const year = rawDate.getUTCFullYear();
                const formattedDate = `${day}/${month}/${year}`;


                const statusText = res.is_active ? "Active" : "Inactive";
                const statusClass = res.is_active ? "active" : "inactive";
                
                // Build Planet Badges
                const ALL_PLANETS = [
                    "Corellia", "Dantooine", "Dathomir", "Endor", "Kashyyyk", 
                    "Lok", "Mustafar", "Naboo", "Rori", "Talus", "Tatooine", "Yavin"
                ];
                const assignedPlanets = (res.planets || []).map(p => p.toLowerCase());
                const availableOptions = ALL_PLANETS
                    .filter(p => !assignedPlanets.includes(p.toLowerCase()))
                    .map(p => `<option value="${p.toLowerCase()}">${p}</option>`)
                    .join('');

                const planetBadges = (res.planets || []).map(p => {
                    const planetLower = p.toLowerCase();
                    return `<span class="planet ${planetLower}" 
                                  data-tooltip="${p}" 
                                  onclick="handleBadgeClick(event, '${res.name}', '${planetLower}')">
                                  ${p.charAt(0).toUpperCase()}
                            </span>`;
                }).join(' ');
                row.innerHTML = `
                    <td class="res-name">${res.name}</td>
                    <td class="res-type">${res.type}</td>
                    <td class="stat-cell ${res.res_oq > 900 ? 'high-quality' : ''}">${res.res_oq || '--'}</td>
                    <td class="stat-cell">${res.res_cd || '--'}</td>
                    <td class="stat-cell">${res.res_dr || '--'}</td>
                    <td class="stat-cell">${res.res_fl || '--'}</td>
                    <td class="stat-cell">${res.res_hr || '--'}</td>
                    <td class="stat-cell">${res.res_ma || '--'}</td>
                    <td class="stat-cell">${res.res_pe || '--'}</td>
                    <td class="stat-cell">${res.res_ut || '--'}</td>
                    <td class="location-cell">
                        <div class="planets-container">${planetBadges}</div>
                        <div class="planet-controls">
                            <select class="planet-select" onchange="togglePlanet(this, '${res.name}')">
                                <option value="" disabled selected>+</option>
                                ${availableOptions}
                            </select>
                        </div>
                    </td>
                    <td class="date-cell">${formattedDate}</td>
                    <td class="status-cell">
                        <div class="status-container">
                            <span class="status-text ${statusClass}">${statusText}</span>
                            <button class="toggle-status-btn" onclick="toggleStatus(this, '${res.name}')" data-tooltip="Toggle Status"></button>
                        </div>
                    </td>
                    <td class="stat-cell"></td>
                `;
                tableBody.appendChild(row);
            });
        } catch (error) {
            console.error("Error loading resources:", error);
        }

    }

    

    let currentSelectedId = 1;
    let currentSelectedLabel = "Resources";
    async function loadTaxonomy() {
        const response = await fetch('http://127.0.0.1:5000/api/taxonomy');
        taxonomyData = await response.json();
        
        taxonomyMap = {}; 
        taxonomyData.forEach(item => {
            if (item.parent_id !== null) {
                if (!taxonomyMap[item.parent_id]) taxonomyMap[item.parent_id] = [];
                taxonomyMap[item.parent_id].push(item.id);
            }
        });

        const listContainer = document.getElementById('taxonomy-list');
        listContainer.innerHTML = '';

        // Create the single consolidated Root item
        const rootItem = document.createElement('div');
        rootItem.className = 'dropdown-item root-item';
        rootItem.textContent = "All Resources";
        // Point directly to ID 1 (Resources) logic
        rootItem.onclick = () => selectCategory(1, "Resources", "All Resources"); 
        listContainer.appendChild(rootItem);

        function buildBranch(parentId, container) {
            const children = taxonomyData.filter(item => item.parent_id === parentId);
            
            children.forEach(child => {
                const hasChildren = taxonomyMap[child.id] && taxonomyMap[child.id].length > 0;
                
                // Create the Item wrapper
                const itemDiv = document.createElement('div');
                itemDiv.className = 'dropdown-item-wrapper';
                
                // The clickable row
                const row = document.createElement('div');
                row.className = 'dropdown-item';
                row.style.paddingLeft = `${child.tree_level * 15}px`;
                
                if (hasChildren) {
                    const icon = document.createElement('span');
                    icon.className = 'toggle-icon';
                    icon.innerHTML = 'â–¼';
                    icon.onclick = (e) => {
                        e.stopPropagation(); // Don't trigger category selection
                        const subBranch = itemDiv.querySelector('.branch-container');
                        subBranch.classList.toggle('hidden');
                        icon.classList.toggle('collapsed');
                    };
                    row.appendChild(icon);
                } else {
                    const spacer = document.createElement('span');
                    spacer.style.width = '21px'; // Match icon width
                    row.appendChild(spacer);
                }

                const label = document.createElement('span');
                label.textContent = child.class_label;
                label.onclick = () => selectCategory(child.id, child.class_label);
                row.appendChild(label);

                itemDiv.appendChild(row);

                // If it has children, create a sub-container
                if (hasChildren) {
                    const subBranch = document.createElement('div');
                    subBranch.className = 'branch-container';
                    buildBranch(child.id, subBranch);
                    itemDiv.appendChild(subBranch);
                }

                container.appendChild(itemDiv);
            });
        }
        if (taxonomyMap[1]) {
            buildBranch(1, listContainer);    
        }
    }

    function toggleDropdown() {
        const list = document.getElementById('taxonomy-list');
        list.style.display = list.style.display === 'block' ? 'none' : 'block';
    }

    function selectCategory(id, classLabel, displayLabel = null) {
        // Update the UI text - use displayLabel if provided (e.g., "All Resources")
        document.querySelector('.dropdown-selected').textContent = displayLabel || classLabel;
        
        currentSelectedId = id;
        currentSelectedLabel = classLabel.toLowerCase();
        
        // Close the dropdown
        document.getElementById('taxonomy-list').style.display = 'none';
        
        // Trigger the combined filter
        applyFilters();
    }

    function getDescendantLabels(parentId) {
        let labels = [];
        const childrenIds = taxonomyMap[parentId] || [];

        childrenIds.forEach(childId => {
            const child = taxonomyData.find(t => t.id === childId);
            if (child) {
                labels.push(child.class_label.toLowerCase());
                labels = labels.concat(getDescendantLabels(childId));
            }
        });
        return labels;
    }

    function applyFilters() {
        const searchTerm = document.querySelector('.search-input').value.toLowerCase();
        
        // If id is 1 (Resources), we show everything that matches the search
        const isRoot = currentSelectedId === 1;
        
        const validHierarchyLabels = !isRoot ? 
            [currentSelectedLabel, ...getDescendantLabels(currentSelectedId)] : 
            [];

        const rows = document.querySelectorAll('#resource-log-body tr');

        rows.forEach(row => {
            const resourceType = row.querySelector('.res-type').textContent.toLowerCase();
            const resourceName = row.querySelector('.res-name').textContent.toLowerCase();

            const matchesSearch = resourceName.includes(searchTerm) || resourceType.includes(searchTerm);
            
            // If it's the root, category match is always true. 
            // Otherwise, check if the type is in the valid hierarchy.
            const matchesCategory = isRoot || validHierarchyLabels.includes(resourceType);

            row.style.display = (matchesSearch && matchesCategory) ? "" : "none";
        });
    }

    document.querySelector('.search-input').addEventListener('input', applyFilters);
    document.querySelector('.dropdown-selected').addEventListener('change', applyFilters);

    document.querySelectorAll('.nav-btn').forEach(button => {
        button.addEventListener('click', () => {
            const targetId = button.getAttribute('data-target');

            // 1. Update Buttons
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');

            // 2. Update Containers
            document.querySelectorAll('.page-container').forEach(container => {
                container.classList.remove('active');
            });
            document.getElementById(targetId).classList.add('active');
            
            // 3. Conditional Logic
            // Hide the search/taxonomy filters if we aren't on the Resources page
            const headerControls = document.querySelector('.header-controls');
            headerControls.style.visibility = (targetId === 'resources-container') ? 'visible' : 'hidden';
        });
    });

window.onload = async() => {
    let taxonomyData = [];
    let taxonomyMap = {};
    // let currentSelectedId = null;
    await Promise.all([
        loadResources(),
        loadTaxonomy()
    ]);

    applyFilters();
}
</script>
</body>
</html>